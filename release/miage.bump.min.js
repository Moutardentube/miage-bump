/**
 * MIAGE Bump
 * @version v0.3.1
 * @link 
 */
"use strict";angular.module("miage.bump",["miage.bump.button","miage.bump.profile","eklabs.angularStarterPack.user","ngMaterial"]).config(function(a){a.iconSet("material-design","/public/material-design.svg",24)}),angular.module("miage.bump.button",[]),angular.module("miage.bump.profile",[]),angular.module("miage.bump.button").directive("bumpButton",function(a,b,c,d,e){return{templateUrl:"miage.bump/modules/button/directives/button/view.html",scope:{user:"=",url:"=?",container:"=?",tags:"=?",callback:"=?"},link:function(f){function g(a){var b=d.defer();c.get(a).then(function(a){var c=new DOMParser,d=c.parseFromString(a.data,"text/html");b.resolve(h(d))},function(a){b.reject(a)})}function h(b){if("string"==typeof b&&(b=document.querySelector(b)),b instanceof HTMLIFrameElement)b=b.contentDocument;else if(!Node.prototype.isPrototypeOf(b))throw new TypeError("[Button Directive] argument container must be either a Node or a Stringinstance, got: "+Object.prototype.toString.call(b));a.info("[Button Directive] Retrieving contents from: ",b);var c={},d=[c];(Document.prototype.isPrototypeOf(b)||"HTMLDocument"===b.constructor.name)&&(d.push(i(b)),d.push(j(b))),d.push(k(b)),angular.merge.apply(null,d);var e=/\Wle\W|\Wla\W|\Wles\W|\Wl'|\Wl'|\Wde\W|\Wdu\W|\Wdes\W|\Wd'|\Wd'|\Wmais\W|\Wou\W|\Wet\W|\Wdonc\W|\Wor\W|\Wni\W|\Wcar\W|\Wque\W|\Wqu'|\Wsi\W|\Wlorsque\W|\Wcomme\W|\Wpuisque\W|\Wquand\W|\Wdans\W|\Wà\W|\Wa|\Wchez\W|\Wen\W|\Wdans\W|\Wavant\W|\Wdevant\W|\Waprès\W|\Wderrière\W|\Wpar\W|\Wpour\W|\Wavec\W|\Wentre\W|\Wjusque\W|\Wjusqu'|\Wcontre\W|\Wsur\W|\Wsous\W|\Wvers\W|\Wsans\W|\Wenvers\W|\Wprès\W|\Wauprès\W|\Wautour\W|\d\D|[.,\/#!$%\^&*;:{}=\-_'~()«»"@\n\t]/gi,f=/\s{2,}/g;for(var g in c)0!==c[g].lastIndexOf("http",0)&&(c[g]=c[g].replace(e," ").replace(f," ").toLowerCase());a.info("[Button Directive] Contents retrieved and filtered: ",c);var h=Object.keys(c).reduce(function(a,b){return angular.forEach(c[b].split(" "),function(c){"number"==typeof l[b]&&(a[c]=(a[c]||0)+l[b])}),a},{});return Object.keys(h).filter(function(a){return h[a]>m}).reduce(function(a,b){return a.push(b),a},[])}function i(a){var b,c,d,e,f={},g=[/site/i,/name/i,/keywords/i,/description/i,/language/i,/url/i,/image/i],h=a.querySelectorAll("meta");for(b=0,d=h.length;b<d&&g.length>0;b++)for(c=0,e=g.length;c<e;c++)if(h[b].hasAttribute("name")&&h[b].getAttribute("name").search(g[c])!==-1){f[g[c].source]=h[b].getAttribute("content"),g.splice(c,1);break}return f}function j(a){var b={};return b.title=a.querySelector("title").innerHTML,b.language=a.documentElement.lang,b}function k(a){for(var b={},c=1,d=function(){var a=Array.prototype.slice.call(arguments,0),b=a.shift();return Array.prototype.map.apply(b,a)},e=function(a){return a.textContent||a.innerText};null===a.querySelector("h"+c);)c++;return b.hN=d(a.querySelectorAll("h"+c),e).join(" "),b.hNminus1=d(a.querySelectorAll("h"+ ++c),e).join(" "),b.hNminus2=d(a.querySelectorAll("h"+ ++c),e).join(" "),b}const l={description:5,hN:7,hNminus1:5,hNminus2:3,keywords:1,name:1,site:1,title:9,url:1},m=15;f.$watch("user",function(a){f.myUser=a}),f.$watch("url",function(a){f.myUrl=a}),f.$watch("container",function(a){f.myContainer=a}),f.$watch("tags",function(a){f.myTags=a});var n={onBump:function(a,b,c,d){var e;e=void 0!==d?d:void 0!==c?h(c):void 0!==b?g(b):[],f.showDialog(e,b)}};f.$watch("callback",function(a){a instanceof Object?f.actions=angular.extend({},n,a):f.actions=n}),f.showDialog=function(c,d){function g(b,c,d,g){d.unshift(""),b.tags=d,b.closeDialog=function(){c.hide()},b.confirmBump=function(){var c=new e({idUser:f.user.id,url:g,tag:d.slice(1,d.length)});a.info("[Button Directive] Inserting following bump in remote database: ",c),c.create().then(function(b){console.log(b),a.info("[Button Directive] Insertion succeeded")},function(b){console.log(b),a.error("[Button Directive] Insertion failed, got: ",b)}),b.closeDialog()},b.addTag=function(a){""!==a&&(b.tags.splice(1,0,a),b.tags[0]="")},b.editTag=function(a){},b.deleteTag=function(a){b.tags.splice(a,1)}}b.show({template:'<md-dialog aria-label="Bump?">   <md-dialog-content>       <md-list layout="column" layout-padding>           <md-list-item layout="row" layout-align="space-between center">                <md-input-container>                    <input placeholder="Renseignez un tag"                           ng-model="tags[0]" />                </md-input-container>                <md-button ng-click="addTag(tags[0])">                    <md-icon md-svg-src="material-design:add"></md-icon>                </md-button>           </md-list-item>           <md-list-item layout="row" layout-align="space-between center"                         ng-repeat="tag in tags" ng-if="$index > 0">                <md-input-container>                    <input ng-model="tag" />                </md-input-container>                <md-button ng-click="deleteTag($index)">                    <md-icon md-svg-src="material-design:delete"></md-icon>                </md-button>           </md-list-item>       </md-list>   </md-dialog-content>   <md-dialog-actions>       <md-button ng-click="closeDialog()">Cancel</md-button>       <md-button ng-click="confirmBump()">Bump!</md-button>   </md-dialog-actions></md-dialog>',locals:{tags:c,url:d},controller:g})}}}}),angular.module("miage.bump.button").directive("bumpDialog",function(a){return{templateUrl:"miage.bump/modules/button/directives/dialog/view.html",scope:{user:"=",url:"=?",tags:"=?",callback:"=?"},link:function(b){b.$watch("user",function(a){b.myUser=a}),b.$watch("url",function(a){b.myUrl=a});var c={onValidate:function(b){a.info("User is ",b)}};b.$watch("callback",function(a){a instanceof Object?b.actions=angular.extend({},c,a):b.actions=c})}}}),angular.module("miage.bump.button").directive("bumpFrame",function(a){return{templateUrl:"miage.bump/modules/button/directives/frame/view.html",scope:{user:"=?",url:"=",container:"=?",tags:"=?",callback:"=?"},link:function(b,c){c.find("iframe").on("load",function(){b.isLoading=!1,b.$apply()});var d=c.find("#input-url");b.$watch("user",function(a){b.myUser=a}),b.$watch("url",function(a){b.myUrl="string"==typeof a&&a.length>0?a:"about:blank",b.isLoading=!0,d.prop("value",a),d.triggerHandler("focus"),d.triggerHandler("blur")}),b.$watch("container",function(a){b.myContainer=a}),b.$watch("tags",function(a){b.myTags=a}),b.setUser=function(a){},b.setUrl=function(a){if(13===a.keyCode){var c=a.target.value;c!==b.myUrl&&(b.isLoading=!0,b.myUrl=c)}};var e={onLoad:function(c){a.info("Loaded url: ",c),b.isLoading=!1,b.$apply()}};b.actions=e,b.$watch("callback",function(a){a instanceof Object?b.actions=angular.extend({},e,a):b.actions=e})}}}),angular.module("miage.bump.profile").directive("bumpMatches",function(a){return{require:"^^bumpProfile",templateUrl:"miage.bump/modules/profile/directives/matches/view.html",scope:{user:"=",userMatches:"=?"},link:function(a,b,c,d){a.$watchGroup(["user","userMatches"],function(b){var c=b[0],e=b[1];return void 0===a.myUser&&void 0===a.myMatches&&void 0!==c&&void 0!==e?(a.myUser=c,void(a.myMatches=e)):(a.myMatches=e,void(c!==a.myUser&&(a.myUser=c,void 0!==c&&d.getMatchingProfiles())))})}}}),angular.module("miage.bump.profile").directive("bumpProfile",function(a,b,c,d,e){return{templateUrl:"miage.bump/modules/profile/directives/profile/view.html",scope:{user:"="},controller:function(c,f){this.bumps=new b,this.users=new d,this.userBumps=[],this.relatedTags=[],this.userTagCount=0,c.selectedNav="tops",c.isLoading=!0,e.all(this.bumps.fetch(),this.users.fetch()).then(function(){f.go("bumpProfile."+c.selectedNav),c.isLoading=!1}),c.$watch("user",function(a){this.myUser=a,c.myUser=a}.bind(this)),c.$watch("userTags",function(a){this.userTags=a}.bind(this)),c.$watch("trendingTags",function(a){this.trendingTags=a}.bind(this)),c.$watch("userMatches",function(a){this.userMatches=a}.bind(this)),this.getRelatedTags=function(b){this.relatedTags=this.userBumps.filter(function(a){return a.tags.indexOf(b)!==-1}).reduce(function(a,b){return a.concat(b.tags)},[]).filter(function(a){return a!==b}).reduce(function(a,b){return a[b]=(a[b]||0)+1,a},{}),a.info("[Profile Controller] Related tags: ",this.relatedTags)},this.getBumps=function(){this.userBumps=this.bumps.filterByUser(c.myUser.id),this.userTagCount=0,c.userTags=this.userBumps.reduce(function(a,b){return a.concat(b.tags)},[]).reduce(function(a,b){return a[b]=(a[b]||0)+1,this.userTagCount++,a}.bind(this),{}),a.info("[Profile Controller] Tag list: ",c.userTags),a.info("[Profile Controller] Tag count: ",this.userTagCount)},this.getFriendsBumps=function(){var b=this.bumps.filterByUsers(c.myUser.friends);c.trendingTags=b.reduce(function(a,b){return a.concat(b.tags)},[]).reduce(function(a,b){return a[b]=(a[b]||0)+1,a},{}),a.info("[Profile Controller] Trending tags: ",c.trendingTags)},this.getMatchingProfiles=function(){if(0===this.userTagCount){if(0===this.bumps.filterByUser(c.myUser.id).length)return void a.info("[Profile Controller] User has no bumps yet");this.getBumps()}var b={},d=[],f=c.myUser.friends.concat([c.myUser.id]),g=this.bumps.filterByUsers(f,!0),h=g.reduce(function(a,b){return a[b.userId]=(a[b.userId]||[]).concat(b.tags),a},{});angular.forEach(Object.keys(h),function(a){var d,e,f=0,g=0,i=0,j=h[a].reduce(function(a,b){return a[b]=(a[b]||0)+1,i++,a},{});angular.forEach(j,function(a,b){b in c.userTags&&(f+=1/Object.keys(j).length,d=a/i,e=a/i/(c.userTags[b]/this.userTagCount),g+=d*=e<1?e:1/e)}.bind(this)),b[a]=.5*f+.5*g}.bind(this)),e.all(d).then(function(d){c.userMatches=Object.keys(b).map(function(a){return angular.merge({match:b[a]},this.findUser(a))}.bind(this)),a.info("[Profile Controller] User matches: ",c.userMatches)}.bind(this))},this.findUser=function(a){return this.users.items.find(function(b){return b.id===a})}}}}),angular.module("miage.bump.profile").directive("bumpTops",function(a){return{require:"^^bumpProfile",templateUrl:"miage.bump/modules/profile/directives/tops/view.html",scope:{user:"=",userTags:"=?"},link:function(a,b,c,d){a.selectedTag=null,a.relatedTags=[],a.$watchGroup(["user","userTags"],function(b){var c=b[0],e=b[1];return void 0===a.myUser&&void 0===a.myTags&&void 0!==c&&void 0!==e?(a.myUser=c,void(a.myTags=e)):(a.myTags=e,void(c!==a.myUser&&(a.myUser=c,void 0!==c&&d.getBumps())))}),a.getRelatedTags=function(b){d.getRelatedTags(b),a.relatedTags=d.relatedTags,a.selectedTag=b}}}}),angular.module("miage.bump.profile").directive("bumpTrends",function(a){return{require:"^^bumpProfile",templateUrl:"miage.bump/modules/profile/directives/trends/view.html",scope:{user:"=",trendingTags:"=?"},link:function(b,c,d,e){b.maxCount=0,b.$watchGroup(["user","trendingTags"],function(c){var d=c[0],f=c[1];return void 0===b.myUser&&void 0===b.myTrends&&void 0!==d&&void 0!==f?(b.myUser=d,void(b.myTrends=f)):(b.myTrends=f,"object"==typeof f&&(b.maxCount=Object.keys(f).reduce(function(a,b){return a>f[b]?a:f[b]},0)),a.info(b.maxCount),void(d!==b.myUser&&(b.myUser=d,void 0!==d&&e.getFriendsBumps())))})}}}),angular.module("miage.bump.config",[]).factory("$config",function(a){var b=angular.extend({},a);return{get:function(a){return b[a]}}}),angular.module("miage.bump").factory("Bump",function(a,b,c){var d=a.get("api")+"/bump/",e=function(a){if("object"!=typeof a)throw new TypeError("The following Bump is malformed: "+angular.toJson(a));this.id=a.id,this.userId=a.idUser,this.img=a.img,this.url=a.url,this.tags=a.tag};return e.prototype=Object.create({}),e.prototype.constructor=e,e.prototype.getId=function(){return this.id},e.prototype.getUserId=function(){return this.userId},e.prototype.getImg=function(){return this.img},e.prototype.getUrl=function(){return this.url},e.prototype.getTags=function(){return this.tags},e.prototype.getPicture=function(){return this.photo?this.photo:"http://91.134.241.60:8020/images/mbs.core/icons/bump.png"},e.prototype.toApi=function(){return{idUser:this.userId,img:this.img,url:this.url,tag:this.tags}},e.prototype.get=function(a){var f=c.defer(),g=d+(a?a:this.id?this.id:void 0);return b.get(g).then(function(a){f.resolve(new e(a.data))},function(a){f.reject(a)}),f.promise},e.prototype.create=function(){var a=c.defer();return b.post(d,this.toApi()).then(function(b){this.id=b.data.id,a.resolve(this)}.bind(this),function(b){a.reject(b)}),a.promise},e.prototype.delete=function(){return b.delete(d+this.getId())},e.prototype.update=function(a){return b.put(d+this.getId(),a)},e.prototype.clone=function(){return new e(this)},e}),angular.module("miage.bump").factory("Bumps",function(a,b,c,d,e){var f=b.get("api")+"/bump/",g=function(a){this.ids=[],this.items=[],"object"==typeof a&&this.addItems(a)};return g.prototype=Object.create({}),g.prototype.constructor=g,g.prototype.fetch=function(){return c.get(f).then(function(a){this.addItems(a.data)}.bind(this))},g.prototype.filterByUser=function(a){return this.items.filter(function(b){return b.userId===a})},g.prototype.filterByUsers=function(a,b){return b===!0?this.items.filter(function(b){return a.indexOf(b.userId)===-1}):this.items.filter(function(b){return a.indexOf(b.userId)!==-1})},g.prototype.addItems=function(a){Array.isArray(a)?angular.forEach(a,function(a){this.addItem(a)}.bind(this)):this.addItem(data)},g.prototype.addItem=function(b){try{var c=new e(b);c.getId()&&this.ids.indexOf(c.getId())===-1&&(this.ids.push(c.getId()),this.items.push(c))}catch(b){a.warn(b.message)}},g.prototype.isEmpty=function(){return 0==this.ids.length},g}),angular.module("miage.bump").filter("trusted",function(a){return function(b){return a.trustAsResourceUrl(b)}});